# typed: true
# frozen_string_literal: true

require_relative "../cli_spec"

module Tapioca
  class TodoSpec < CliSpec
    describe("#todo") do
      before do
        execute("init")
      end

      it "does nothing if all constant are already resolved" do
        output = execute("todo")

        assert_equal(<<~OUTPUT, output)
          Compiling sorbet/rbi/todo.rbi, this may take a few seconds... Nothing to do
        OUTPUT

        refute_path_exists(repo_path / "sorbet/rbi/todo.rbi")
      end

      it "creates a list of all unresolved constants" do
        File.write(repo_path / "file.rb", <<~RUBY)
          class Foo < ::Undef1
            def foo
              Undef2.new
            end
          end

          ::Undef1::Undef3.foo
          Undef2::Undef4.bar
        RUBY

        output = execute("todo")

        File.delete(repo_path / "file.rb")

        assert_equal(<<~CONTENTS, output)
          Compiling sorbet/rbi/todo.rbi, this may take a few seconds... Done
          All unresolved constants have been written to sorbet/rbi/todo.rbi.
          Please review changes and commit them.
        CONTENTS

        assert_path_exists(repo_path / "sorbet/rbi/todo.rbi")
        assert_equal(<<~CONTENTS, File.read(repo_path / "sorbet/rbi/todo.rbi"))
          # DO NOT EDIT MANUALLY
          # This is an autogenerated file for unresolved constants.
          # Please instead update this file by running `bin/tapioca todo`.

          # typed: false

          module ::Undef1; end
          module ::Undef1::Undef3; end
          module ::Undef2::Undef4; end
          module Foo::Undef2; end
        CONTENTS
      end

      it "creates a TODO file without header" do
        File.write(repo_path / "file.rb", <<~RUBY)
          class Foo < ::Undef1; end
        RUBY

        output = execute("todo", "--no-file-header")

        File.delete(repo_path / "file.rb")

        assert_equal(<<~CONTENTS, output)
          Compiling sorbet/rbi/todo.rbi, this may take a few seconds... Done
          All unresolved constants have been written to sorbet/rbi/todo.rbi.
          Please review changes and commit them.
        CONTENTS

        assert_path_exists(repo_path / "sorbet/rbi/todo.rbi")
        assert_equal(<<~CONTENTS, File.read(repo_path / "sorbet/rbi/todo.rbi"))
          # typed: false

          module ::Undef1; end
        CONTENTS
      end

      it "deletes the todo.rbi file when everything is resolved" do
        FileUtils.mkdir_p(repo_path / "sorbet/rbi")
        File.write(repo_path / "sorbet/rbi/todo.rbi", <<-RBI)
          # DO NOT EDIT MANUALLY
          # This is an autogenerated file for unresolved constants.
          # Please instead update this file by running `bin/tapioca todo`.

          # typed: false

          module ::Undef1; end
          module ::Undef1::Undef2; end
          module ::Undef2::Undef4; end
          module Foo::Undef2; end
        RBI

        output = execute("todo")

        assert_equal(<<~OUTPUT, output)
          Compiling sorbet/rbi/todo.rbi, this may take a few seconds... Nothing to do
        OUTPUT

        refute_path_exists(repo_path / "sorbet/rbi/todo.rbi")
      end
    end
  end
end
